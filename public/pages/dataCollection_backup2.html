<!DOCTYPE html>
<html>
<head>
	<!--Page Title-->
	<title>IIIT Dharwad, Data Collection</title>
	<!--Links-->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">


	<!--Links to the external CSS Files-->
	<link rel="stylesheet" href="./css/index.css">
	<link rel="stylesheet" type="text/css" href="./css/footer.css">
	<link rel="stylesheet" type="text/css" href="./css/carousel.css">
	<link rel="stylesheet" type="text/css" href="./css/dataCollection.css">
	<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
	<!--Links to the external javascript files-->
	
	<!--Internal CSS-->
	<style type="text/css">
		.aboutus {
			margin: 50px 50px 20px 50px;
			text-align: justify;
			text-justify: inter-word;
		}
	</style>
</head>
<body>
	<!--Page Header-->
	<header class="header">
		<h1>Data Collection Facility, IIIT, Dharwad</h1>
	</header>

	<!--Page Navigation Links-->
	<nav class="navbar">
		<a href="/">Home</a>
  		<a href="aboutus">About Us</a>
  		<a href="dataCollection">Data Collection Facility</a>
  		<a href="contactus">Contact us</a>
	</nav>
	
	<!--Section for Data-->
	<section class="row">
		<!--Page Left Column-->
		<aside class="leftcol">
			<h3></h3>
		</aside>

		<!--Page Main Cntent-->
		<main class="main">
			<!--Input Form-->
			<section>
				<div class="inputCount">
					<form>
						<label>How many sentences do you want to record: </label><br><br>
						<input type="number" class="eleCount" id="eleCount" min="1" max="10">
						<input type="button" class="submit" id="submit" value="submit"><hr>
					</form>
				</div>

				<div class="libAudio">
					<fieldset class="inputCount">
						<legend>Read the Text Carefully</legend>
						<p>
							Text Here
						</p>
						<!--
						<audio controls autoplay>
  							<source src="#" type="audio/ogg">
  							Your browser does not support the audio tag.
						</audio>
					-->
					</fieldset>
				</div>
				<hr>
				<!--Element to show the camera stream-->
				<div class="accessCamera">
					<h4 class="head4">Video Recording Window</h4>
					<div class="accessCamera1">
						<video class="videoStream" autoplay="true" id="videoStream" muted>
						<!--Here camera video stream will be shown on the webpage-->
						</video>
					</div>
					<br>
					<button class="startVid" id="startVid">Start Recording</button>
					<button class="stopVid" id="stopVid">Stop Recording</button>
					<br>
					<br>
					<a id="download">Download</a>
				</div>

				<hr class="end">
				<div class="displayVideo">
					<video id="vidSave" class="vidSave" controls>
						
					</video>
				</div>
			</section>
		</main>

		<!--Page Right Column-->
		<aside class="rightcol">
			<h3></h3>
		</aside>
	</section>

	<!--Page Footer-->
	<footer class="footer">
		<aside class="footcol">
			<h3>About Us</h3>
			<p>IIIT, Dharwad</p>
		</aside>
		<aside class="footcol">
			<h4>Related Links</h4>
			<a href="http://www.walchandsangli.ac.in" target="_blank">IIIT Dharwad</a> <br>
			<a href="https://www.aicte-india.org/" target="_blank">AICTE</a> <br>
			<a href="https://www.ugc.ac.in/" target="_blank">UGC</a> 
		</aside>
		<aside class="footcol">
			<h4>Follow WCE</h4>
			<a href="https://www.facebook.com/" target="_blank">Facebook</a> <br>
			<a href="https://twitter.com/" target="_blank">Twitter</a>
			<br>
			<a href="https://www.instagram.com/" target="_blank">Instagram</a> 
		</aside>
		<section align="Center">
			<i><b>All rights are reserved to IIIT Dharwad</b></i>
		</section>
	</footer>

	<script type="text/javascript">
		const recordCount = document.getElementById('eleCount').value;
		
		/*
			This is a click event listener for the button with id submit.
		  	Here based on the input from the user, number of video elements
		  	will be created dynamically.		 
		*/
		submit.addEventListener('click', (ev) =>
		{
			const elements = document.getElementById('eleCount').value;
			console.log(elements);
			const labArr = new Array(elements);
			const vidArr = new Array(elements);
			let i = 0;
			const parent = document.getElementById("vidSave");
			while(i<elements)
			{
				//Create a label for video element
				labArr[i] = document.createElement('label');
				labArr[i].setAttribute("class", "testLab");
				const val = "video " + (i+1);
				const labelName = document.createTextNode(val);
				labArr[i].appendChild(labelName);
				var pos = document.getElementById('end');
				document.body.insertBefore(labArr[i], pos);

				//breakline
				
				//Create an video element
				vidArr[i] = document.createElement('video');
				vidArr[i].setAttribute("width", "30%");
				vidArr[i].setAttribute("background-color","#666");
				vidArr[i].setAttribute("autoplay","true");
				vidArr[i].setAttribute("controls", "controls");
				document.body.appendChild(vidArr[i]);
				pos = document.getElementById('testLab');
				document.body.insertBefore(vidArr[i], pos);
				console.log(i);
				i++;
			}
		});

		let video = document.querySelector("#videoStream");
		let mediaRecorder;

		//Following code will autostart the webcam when webpage loads
		navigator.mediaDevices.getUserMedia({
	    	video: true,
	    	audio: true
		}).then (function(mediaStreamObj)
		{
        	video.srcObject = mediaStreamObj;
            mediaRecorder= new MediaRecorder(mediaStreamObj);
        });
        
        let chunks = [];
        let videoURL;

        /*This is a click event listener for the button with id startVid
		  Here media recorder will start recording the stream coming from
		  the webcam and will store it as a blob
		 */
		var inc = 0;
        startVid.addEventListener('click', (ev)=>
        {
    		if (mediaRecorder.state == 'inactive')
    		{
        		mediaRecorder.start();
        		startVid.disabled = true;
        		stopVid.disabled = false;

	        	mediaRecorder.onstop = (ev)=>
	        	{
		            let blob = new Blob(chunks,
		            	{
		            		'mimeType':'video/webm',
		            		'codecs':'codecs=vp8'
		            	});
		            chunks = [];
		            var temp = inc;
		            //Create New Video Element
		            const lName = "video " + (temp);
		            var newLabel = document.createElement('label');
					newLabel.setAttribute("class", lName);
					newLabel.setAttribute("id", lName);
					const labelName = document.createTextNode(lName);
					newLabel.appendChild(labelName);
					var pos = document.getElementById('end');
					document.body.insertBefore(newLabel, pos);

					//breakline
					
					//Create an video element
					
					const vName = "video" + (temp);
					var newVideo = document.createElement('video');
					newVideo.setAttribute("class", vName);
					newVideo.setAttribute("id", vName);
					newVideo.setAttribute("width", "25%");
					newVideo.setAttribute("background-color","#666");
					newVideo.setAttribute("autoplay","true");
					newVideo.setAttribute("controls", "controls");
					document.body.appendChild(newVideo);
					pos = document.getElementById('testLab');
					document.body.insertBefore(newVideo, pos);
			        //Closed
		            videoURL = window.URL.createObjectURL(blob);
		            newVideo.src = videoURL;

		            const a = document.createElement('a');
		            a.display = "none";
		            a.href = videoURL;
		            a.download = vName+".webm";
		            a.click();
		            vidSave.src = videoURL;
		            //sendData(blob);
		            /*
		            const downloadLink = document.getElementById('lName');
		            downloadLink.href = URL.createObjectURL(new Blob(chunks));
		      		downloadLink.download = 'acetest.mp4';*/
        		}

		        mediaRecorder.ondataavailable = function(ev)
		        {
		            chunks.push(ev.data);
		            console.log(chunks);
		        }
    		}
    		else
        	{
        		startVid.disabled = false;
        		stopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
            inc++;
    	});


        /*This is a click event listener for the button with id stopVid
		  Here media recorder will stop recording the stream coming from
		  the webcam. Buttons will be enabled and disabled accordingly.
		 */
        stopVid.addEventListener('click', (ev)=>
        {
           if (mediaRecorder.state != 'inactive') {
        		mediaRecorder.stop();
        		stopVid.disabled = true;
        		startVid.disabled = false;
        	}
        	else{
        		stopVid.disabled = false;
        		startVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
        });

        /*Function to send the blob data to local file system*/
        /*
        function sendData(blob)
        {
		    var fd = new FormData(form);
		    fd.append('file', blob);
		    fd.append('fname', 'test.mp4');
		    console.log(fd);
		    $.ajax({
		        type: 'POST',
		        url:'/postData',
		        data: fd,
		        cache: false,
		        processData: false,
		        contentType: false,
		        success: function(response) {
		            console.log(response);
		        },
		        error: function(error) {
		            console.log(error);
		        }
		    });
		}*/

		//test function
		function recordVid()
        {
    		if (mediaRecorder.state == 'inactive')
    		{
        		mediaRecorder.start();
        		startVid.disabled = true;
        		stopVid.disabled = false;

	        	mediaRecorder.onstop = (ev)=>
	        	{
		            let blob = new Blob(chunks,
		            	{
		            		'mimeType':'video/webm',
		            		'codecs':'codecs=vp8'
		            	});
		            chunks = [];
		            var temp = inc;
		            //Create New Video Element
		            const lName = "video " + (temp);
		            var newLabel = document.createElement('label');
					newLabel.setAttribute("class", lName);
					newLabel.setAttribute("id", lName);
					const labelName = document.createTextNode(lName);
					newLabel.appendChild(labelName);
					var pos = document.getElementById('end');
					document.body.insertBefore(newLabel, pos);

					//breakline
					
					//Create an video element
					
					const vName = "video" + (temp);
					var newVideo = document.createElement('video');
					newVideo.setAttribute("class", vName);
					newVideo.setAttribute("id", vName);
					newVideo.setAttribute("width", "25%");
					newVideo.setAttribute("background-color","#666");
					newVideo.setAttribute("autoplay","true");
					newVideo.setAttribute("controls", "controls");
					document.body.appendChild(newVideo);
					pos = document.getElementById('testLab');
					document.body.insertBefore(newVideo, pos);
			        //Closed
		            videoURL = window.URL.createObjectURL(blob);
		            newVideo.src = videoURL;

		            const a = document.createElement('a');
		            a.display = "none";
		            a.href = videoURL;
		            a.download = vName+".webm";
		            a.click();
		            vidSave.src = videoURL;
		            sendData(blob);
		            /*
		            const downloadLink = document.getElementById('lName');
		            downloadLink.href = URL.createObjectURL(new Blob(chunks));
		      		downloadLink.download = 'acetest.mp4';*/
        		}

		        mediaRecorder.ondataavailable = function(ev)
		        {
		            chunks.push(ev.data);
		            console.log(chunks);
		        }
    		}
    		else
        	{
        		startVid.disabled = false;
        		stopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
            inc++;
    	}

    	function stopRecord()
        {
           if (mediaRecorder.state != 'inactive') {
        		mediaRecorder.stop();
        		stopVid.disabled = true;
        		startVid.disabled = false;
        	}
        	else{
        		stopVid.disabled = false;
        		startVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
        }
		//window.onload = setTimeout(recordVid, 3000);
		window.onload = function ()
		{
				//setInterval(recordVid, 10000);
				//setInterval(stopRecord, 20000);
		}
	</script>
</body>
</html>