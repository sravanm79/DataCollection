<!DOCTYPE html>
<html>
<head>
	<!--Page Title-->
	<title>IIIT Dharwad, Data Collection</title>
	<!--Links-->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!--Links to the external CSS Files-->
	<link rel="stylesheet" href="./css/index.css">
	<link rel="stylesheet" type="text/css" href="./css/footer.css">
	<link rel="stylesheet" type="text/css" href="./css/carousel.css">
	<link rel="stylesheet" type="text/css" href="./css/dataCollection.css">
	<link rel="stylesheet" type="text/css" href="./css/consent.css">
	<!--
		This file is fontawesome css file which is downloaded for offline
		use. This allows the webpages to load the icons without the
		internet connection.
	-->
<!-- 	<link rel="stylesheet" type="text/css" href="./icons/css/all.css">
 -->	
	<!--Link to the jquery-->
	<!-- This file needs internet connectivity 
		<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
	-->
	<!--This is an offline jQuery file i.e. No need of internet connectivity-->
	<script type="text/javascript" src="./js/jquery.js"></script>
	
	<!--Links to the external javascript files-->
	<!--<script type="text/javascript" src="./js/CameraFun.js"></script>-->
	<script type="text/javascript" src="./js/stickyNav.js"></script>
	<!-- <script type="text/javascript" src="./js/audio.js"></script>
	<script src="./js/popupS.min.js"></script> -->
	<script type="text/javascript" src="./js/fontSize.js"></script>
	<script type="text/javascript" src="./js/dateTime.js"></script>
	<script type="text/javascript" src="./js/windowSelector.js"></script>
	<!---->
	<script type="text/javascript" src="./js/wavesurfer-5.2.0.js"></script>
	<script type="text/javascript" src="./js/wavesurfer-timeline.js"></script>
	
	<!-- <script src="https://unpkg.com/wavesurfer.js"></script>
	<script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.timeline.min.js"></script> -->
	<!-- <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script> -->
 	<script type="text/javascript" src="./js/waveform.js"></script>
	<!-- <script type="text/javascript" src="./js/my-worklet-processor.js"></script>
	<script type="text/javascript" src="./js/processor.js"></script> -->
	
	<!--Internal CSS-->
	<style type="text/css">
		.aboutus {
			margin: 50px 50px 20px 50px;
			text-align: justify;
			text-justify: inter-word;
		}
		.stickyNav {
		  position: fixed;
		  top: 0;
		  width: 100%;
		}
	</style>
</head>

<!--Start of the body element-->
<body>
	<!--Page Header-->
	<header class="header">
		<p class="title">Data Collection Facility, IIIT, Dharwad</p>
	</header>

	<!--Page Navigation Links-->
	<nav class="navbar" id="navbar" name="navbar">
		<a href="/">Home</a>
  		<a href="aboutus">About Us</a>
  		<a href="registration">Patient Registration</a>
  		<a href="consent">Consent Form</a>
  		<a href="recordData">Record Data</a>
  		<a href="contactus">Contact us</a>
  		<a href="configure">Settings</a>
	</nav>
	
	<!--Section for Main Data-->
	<section class="row">
		<!--Page Left Column: To keep the left side blank-->
		<aside class="leftcol">
			<h3></h3>
		</aside>

		<!--Page Main Cntent-->
		<main class="main">
			<hr>
			<h2 class="conTitle">Speech to Speech Translation Project-2021 Speaker Consent Form
			</h2>
			<!--Input Form-->
			<section class="recordSection">
				<div class="inputCount">
					<hr>
					<form name="setCount" method="post" action="testing">
						<label for="uname">Enter Speaker ID</label>
						<input type="text" class="uname" id="uname" name="uname" required>
						<input type="submit" value="submit" class="submit" id="submit" name="submit">
						<hr>
					</form>
				</div>
				 <article class="consentContainer">
					<div class="consentKA">
						<ol>
							<li>
								ಬುಡಕಟ್ಟು ಭಾಷೆಗಳಿಗೆ ಧ್ವನಿ ಭಾಷಾ ಅನುವಾದ ಮಾಡುವ ಈ ಯೋಜನೆ ಭಾರತದಲ್ಲಿ ಇದೇ ಮೊದಲು. ಈ ಯೋಜನೆಯನ್ನು ಭಾರತ ಸರ್ಕಾರ ಪ್ರಾಯೋಜಿಸಿದೆ.
							</li>
							<li>
								ನನ್ನ ಒಪ್ಪಿಗೆಯನ್ನು ತೆಗೆದುಕೊಳ್ಳಲಾಗಿದೆ ಮತ್ತು ಇದರ ಮೂಲ ಉದ್ದೇಶವನ್ನು ನಾನು ಅರ್ಥಮಾಡಿಕೊಂಡಿದ್ದೇನೆ ಎಂದು ನಾನು ದೃಡೀಕರಿಸುತ್ತೇನೆ. ಈ ಮೇಲಿನ ಯೋಜನೆಗಾಗಿ ನನ್ನ ಧ್ವನಿಯನ್ನು ಸ್ವಇಚ್ಛೆಯಿಂದ ನೀಡುತ್ತಿದ್ದೇನೆ ಮತ್ತು ನನಗೆ ಈ ಬಗ್ಗೆ ಪ್ರಶ್ನೆಗಳನ್ನು ಕೇಳಲು ಅವಕಾಶವಿತ್ತು. ___________ ದಿನಾಂಕದಂದು ನಾನು ನನ್ನ ಧ್ವನಿಯನ್ನು ಧಾನ ಮಾಡುತಿದ್ದೇನೆ.
							</li>
							<li>
								ನಾನು ಮೇಲೆ ತಿಳಿಸಿದ ಯೋಜನೆಯಲ್ಲಿ ಸ್ಪೀಕರ್ ಆಗಿ ಭಾಗವಹಿಸಲು ಒಪ್ಪುತ್ತೇನೆ.
							</li>
							<li>
								ಪ್ರಾಜೆಕ್ಟ್‌ಗಾಗಿ ರೆಕಾರ್ಡ್ ಮಾಡಿದ ನನ್ನ ಧ್ವನಿಯನ್ನು ವೈಜ್ಞಾನಿಕ ಉದ್ದೇಶಕ್ಕಾಗಿ ಬಳಸಬಹುದೆಂದು ನಾನು ಒಪ್ಪುತ್ತೇನೆ.
							</li>
							<li>
								ನನ್ನ ಗುರುತನ್ನು ಬಹಿರಂಗಪಡಿಸದೆ, ನನ್ನ ಧ್ವನಿಯನ್ನು ಸಾರ್ವಜನಿಕ ಡೊಮೇನ್‌ನಲ್ಲಿ ಅಪ್‌ಲೋಡ್ ಮಾಡಲು ನಾನು ಸ್ವಯಂಪ್ರೇರಣೆಯಿಂದ ಒಪ್ಪಿಗೆ ನೀಡಿದ್ದೇನೆ ಎಂದು ನಾನು ದೃಡೀಕರಿಸುತ್ತೇನೆ.
							</li>
							<li>
								ಈ ತಿಳುವಳಿಕೆಯುಳ್ಳ ಒಪ್ಪಿಗೆ ನಮೂನೆಯ ಆಡಿಯೋ-ದೃಶ್ಯ ರೆಕಾರ್ಡಿಂಗ್ ಬಗ್ಗೆ ನನಗೆ ತಿಳಿದಿದೆ. (ಯಾವುದಾದರೂ ಇದ್ದರೆ)
							</li>
						</ol>
					</div>
					<div class="consentEN">
						ಆಡಿಯೋ ಕೇಳಿ ಆದ ಮೇಲೆ,  ಬೀಪ್ ನ  ನಂತರ  ನಿಮ್ಮ  ಹೆಸರು ಹೇಳಿ, ನಿಮಗೆ ಒಪ್ಪಿಗೆ ಇದೆ ಎಂದು ಸೂಚಿಸಿ. 
						<!-- <ol>
							<li>
								I confirm that I have understood that the purpose for which my consent is being taken dated _________ for the above project and have had the opportunity to ask questions.</li>
							<li>
								I agree to take part in the above mentioned project as a speaker.
							</li>
							<li>
								I agree to the part, that my voice recorded for the project can be used for scientific purpose(s).
							</li>
							<li>
								I confirm that I have given my consent voluntarily, to upload my recorded voice on public domain, without revealing my identity.
							</li>
							<li>
								I am aware of the Audio-visual recording of this informed Consent form.( if any)
							</li>
						</ol>  -->
					</div>
				</article>
				<hr>
				<div class="consentPreAudio">
					<audio class="CPAudio" id="CPAudio" name="CPAudio">
						<source src="./sounds/consent.mp3" type="audio/mp3">
						Your browser does not support the audio tag.
					</audio>
				</div>
				<div class="recIcon">
					<p name="recordingImg" class="recordingImg" id="recordingImg" hidden>ರೆಕಾರ್ಡಿಂಗ್ ಆಗುತ್ತಿದೆ.</p>
					<p name="stoppedRec" class="stoppedRec" id="stoppedRec" hidden>ರೆಕಾರ್ಡಿಂಗ್ ಆಗುತ್ತಿಲ್ಲ.</p>
				</div>
				<!--Element to show the camera stream-->
				<div class="accessCamera">
					<!--Main Audio-Video Recording Window-->
					<div class="accessCamera1" id="accessCamera1">
						<form class="videoStreamF" name="videoStreamF" type='multipart/form-data'>
							<video class="videoStream" name="videoStream" autoplay="true" id="videoStream" muted controls>
							<!--Here camera video stream will be shown on the webpage-->
							</video><br>
							<input type="number" name="un" class="un" id="un" hidden>
							<button class="startVid" id="startVid" hidden>
								<i id = 'start' class="fas fa-microphone" >
								</i>
							</button>
							<button class="stopVid" id="stopVid" hidden>
								<i id = 'stop' class="fas fa-stop">
								</i>
							</button>
						</form>
						<div class="displayVideo" id="displayVideo">
						<!--<video id="vidSave" class="vidSave" controls>	
						</video>-->
						<hr class="end" id="end">
					</div>
					</div>
				</div>
			</section>
		</main>

		<!--Page Right Column: To keep the left side blank-->
		<aside class="rightcol">
			<h3></h3>
		</aside>
		<!--Page Footer-->
		<footer class="footer">
			<aside class="footcol">
				<h3>About Us</h3>
				<p>IIIT, Dharwad</p>
			</aside>
			<aside class="footcol">
				<h4>Related Links</h4>
				<a href="https://iiitdwd.ac.in/" target="_blank">IIIT Dharwad</a> <br>
				<a href="https://www.aicte-india.org/" target="_blank">AICTE</a> <br>
				<a href="https://www.ugc.ac.in/" target="_blank">UGC</a> 
			</aside>
			<aside class="footcol">
				<h4>Follow IIIT Dharwad</h4>
				<a href="https://www.facebook.com/" target="_blank">Facebook</a> <br>
				<a href="https://twitter.com/" target="_blank">Twitter</a>
				<br>
				<a href="https://www.instagram.com/" target="_blank">Instagram</a> 
			</aside>
		</footer>
	</section>

	<section class="copyright" align="Center">
		<i><b>All rights are reserved to IIIT Dharwad</b></i>
	</section>

	<script type="text/javascript">
		var inc=0;
		let video = document.querySelector("#videoStream");
		var aName;
		let mediaRecorder;
        let chunks = [];
        var request;
        let videoURL;
        var serverData;
        var dateTime;
        
		//Following code will autostart the webcam when webpage loads
		navigator.mediaDevices.getUserMedia({
	    	video: true,
	    	audio: true
		}).then (function(mediaStreamObj)
		{
            mediaRecorder = new MediaRecorder(mediaStreamObj);
            video.srcObject = mediaStreamObj;
        });

        /*---------- START OF MAIN RECORDING WINDOW ----------*/
        startVid.addEventListener('click', (ev)=>
        {
    		if (mediaRecorder.state == 'inactive')
    		{
        		mediaRecorder.start();
        		startVid.disabled = true;
        		stopVid.disabled = false;
	        	mediaRecorder.onstop = (ev)=>
	        	{
		            let blob = new Blob(chunks,
		            	{
		            		'type':'audio/mp4',
		            		'codecs':'h.264'
		            	});
		            dateTime = getDateTime();
		            //Create a new division
		            const lName = "video Consent";

		            var newDiv = document.createElement('div');

					newDiv.setAttribute("class", lName);
					newDiv.setAttribute("id", lName);
					newDiv.setAttribute("width", "100%");
					newDiv.setAttribute("height", "auto");
					newDiv.setAttribute("style", "align-content: center; margin:auto;");
					var parent = document.getElementById('displayVideo');
					var child = document.getElementById('end');
					parent.insertBefore(newDiv, child);

		            //Create New Video Element
		            var newLabel = document.createElement('label');
					newLabel.setAttribute("class", lName);
					newLabel.setAttribute("id", lName);
					newLabel.setAttribute("style", "display: none");
					const labelName = document.createTextNode(lName);
					newLabel.appendChild(labelName);
					parent = document.getElementById('displayVideo');
					child = document.getElementById('end');
					parent.insertBefore(newLabel, child);

					//Create an video element
					const vName = "Video Consent";
					var newVideo = document.createElement('video');
					newVideo.setAttribute("class", vName);
					newVideo.setAttribute("id", vName);
					newVideo.setAttribute("width", "25%");
					newVideo.setAttribute("background-color","#666");
					//newVideo.setAttribute("autoplay","false");
					//newVideo.setAttribute("controls", "controls");
					newVideo.setAttribute("style", "display: none");
					document.body.appendChild(newVideo);
					parent.insertBefore(newVideo, end);
			        //Closed
		            videoURL = window.URL.createObjectURL(blob);
		            
		            console.log(videoURL);
		            newVideo.src = videoURL;

		            //Upload to the directory
		            var audio = new FormData();
		            var userName = un.value;
		            aName = dateTime + '_'+ userName + '_' +'KA_Consent.';
		            request = new XMLHttpRequest();
		            //audio.append('file', videoURL);
		            audio.append('content-type', 'multipart/form-data');
		            audio.append('newVideo', blob, aName);
		            audio.append('userName', userName);
		            request.open('post', '/uploadConsent');
		            request.send(audio);
		            chunks = [];
		            blob = [];
		            console.log('Consent form sent to the server for processing.');
		            aName = '';
        		}
		        mediaRecorder.ondataavailable = function(ev)
		        {
		            chunks.push(ev.data);
		            console.log(chunks);
		        }
    		}
    		else
        	{
        		startVid.disabled = false;
        		stopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
    	});

        /*This is a click event listener for the button with id stopVid
		  Here media recorder will stop recording the stream coming from
		  the webcam. Buttons will be enabled and disabled accordingly.
		 */
        stopVid.addEventListener('click', (ev)=>
        {
           if (mediaRecorder.state != 'inactive') {
        		mediaRecorder.stop();
        		stopVid.disabled = true;
        		startVid.disabled = false;
        	}
        	else{
        		stopVid.disabled = false;
        		startVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
        });
        /*---------- END OF MAIN RECORDING WINDOW ----------*/


        /*---------- RECEIVE DATA FROM SERVER ----------*/
        submit.addEventListener('click', async (ev) => 
        {
        	ev.preventDefault();
        	var uName = document.getElementById('uname').value;
        	if(uName=='')
        	{
        		alert('Please enter a valid Speaker ID');
    			uname.value = '';
        	}
        	else
        	{
        		$.ajax({
                type: 'POST',
                url: "/userConsent",
                async: true,
                data: 
                    JSON.stringify({
                        user: uName,
                }),
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                success: function ()
                {
        			document.getElementById('un').value = uName;

        			$.get("/userConsent", async function(data, status)
        			{
				    	serverData = data;
				    	console.log('Data from Server:' + serverData);
						if (serverData === 1) {
							setTimeout(function() {
					    		var audio = new Audio(
					    			'./sounds/beep.wav'
									);
	    							audio.play();
        					}, 2000)

	        				setTimeout(function() {
	        					document.getElementById("startVid").click();
	        					document.getElementById('recordingImg').style.display = 'inline';
	 							document.getElementById('stoppedRec').style.display = 'none';
	        				}, 2000)

	        				setTimeout(function(){
	        					var play = document.getElementById("CPAudio");
	        					play.play();
	        				}, 2000)

	        				setTimeout(function() {
					    		var audio = new Audio(
					    			'./sounds/beep.wav'
									);
	    							audio.play();
        					}, 49000)

	        				setTimeout(function() {
	        					document.getElementById("stopVid").click();
	        					document.getElementById('recordingImg').style.display = 'none';
	 							document.getElementById('stoppedRec').style.display = 'inline';
	 							window.alert('Consent Recorded Successfully.');
	        				}, 55000)
						}
    					else
    					{
    						alert('User Not Found.');
    					}
	        		})
	        	}
	        })
        	}
        	
        })
	</script>
</body>
</html>