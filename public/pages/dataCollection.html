<!DOCTYPE html>
<html>
<head>
	<!--Page Title-->
	<title>IIIT Dharwad, Data Collection</title>
	<!--Links-->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!--Links to the external CSS Files-->
	<link rel="stylesheet" href="./css/index.css">
	<link rel="stylesheet" type="text/css" href="./css/footer.css">
	<link rel="stylesheet" type="text/css" href="./css/carousel.css">
	<link rel="stylesheet" type="text/css" href="./css/dataCollection.css">	
	<!--
		This file is fontawesome css file which is downloaded for offline
		use. This allows the webpages to load the icons without the
		internet connection.
	-->
	<!-- <link rel="stylesheet" type="text/css" href="./icons/css/all.css"> -->
	
	<!--Link to the jquery-->
	<!-- This file needs internet connectivity 
		<script src="https://code.jquery.com/jquery-3.3.1.js"></script>
	-->
	<!--This is an offline jQuery file i.e. No need of internet connectivity-->
	<script type="text/javascript" src="./js/jquery.js"></script>
	
	<!--Links to the external javascript files-->
	<!--<script type="text/javascript" src="./js/CameraFun.js"></script>-->
	<script type="text/javascript" src="./js/stickyNav.js"></script>
	<!-- <script type="text/javascript" src="./js/audio.js"></script>
	<script src="./js/popupS.min.js"></script> -->
	<script type="text/javascript" src="./js/fontSize.js"></script>
	<script type="text/javascript" src="./js/dateTime.js"></script>
	<script type="text/javascript" src="./js/windowSelector.js"></script>
	<!---->
	<script type="text/javascript" src="./js/wavesurfer-5.2.0.js"></script>
	<script type="text/javascript" src="./js/wavesurfer-timeline.js"></script>
	<script type="text/javascript" src="./js/wavesurfer-microphone.js"></script>
	
	<!-- <script src="https://unpkg.com/wavesurfer.js"></script>
	<script src="https://unpkg.com/wavesurfer.js/dist/plugin/wavesurfer.timeline.min.js"></script> -->
	<!-- <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script> -->
 	<script type="text/javascript" src="./js/waveform.js"></script>
	<!-- <script type="text/javascript" src="./js/my-worklet-processor.js"></script>
	<script type="text/javascript" src="./js/processor.js"></script> -->
	
	<!--Internal CSS-->
	<style type="text/css">
		.aboutus {
			margin: 50px 50px 20px 50px;
			text-align: justify;
			text-justify: inter-word;
		}
		.stickyNav
		{
			position: fixed;
			top: 0;
			width: 100%;
		}
	</style>
</head>

<!--Start of the body element-->
<body>
	<!--Page Header-->
	<header class="header">
		<p class="title">Data Collection Facility, IIIT, Dharwad</p>
	</header>

	<!--Page Navigation Links-->
	<nav class="navbar" id="navbar" name="navbar">
		<a href="/">Home</a>
  		<a href="aboutus">About Us</a>
  		<a href="registration">Patient Registration</a>
  		<a href="consent">Consent Form</a>
  		<a href="recordData">Record Data</a>
  		<a href="contactus">Contact us</a>
  		<a href="configure">Settings</a>
	</nav>
	
	<!--Section for Main Data-->
	<section class="row">
		<!--Page Left Column: To keep the left side blank-->
		<aside class="leftcol">
			<h3></h3>
		</aside>

		<!--Page Main Content-->
		<main class="main">
			<hr>
			<section class="winSection">
				<!-- <label for="recWindow" class="recLabel">Select the Recording Window</label> 
				<select class="recWindow" id="recWindow" onchange="windowSelect()">
					<option disabled selected>--- Select the Recording Window ---</option>
					<option value="demo">Demo Recording Window</option>
					<option value="mainA">Main Recording Window (Automatic)</option>
					<option value="mainM">Main Recording Window (Manual)</option>
					<option value="continuous">Continuous Recording Window</option>
					<option value="reRecordWin">Re-Recording Window</option>
				</select> -->
			</section>
			<hr>
			
			<!--Input Form-->
			<section class="recordSection">
				<!--This division is for Demo Recording Window-->
				<div class="demoDiv" id="demoDiv" name="demoDiv">
					<form name="setDemoUser" method="post" onsubmit="return false;">
						<label for="dUser">Enter Speaker ID</label>
						<input type="text" class="dUser" id="dUser" name="dUser" required>
						<button type="button" class="demoSubmit" id="demoSubmit" name="demoSubmit">Submit</button>
					</form>
				</div>

				<!--This division is for Main Recording Window (Automatic)-->
				<div class="inputCount" id="inputCount" name="inputCount" hidden>
					<form name="setCount" method="post" action="testing">
						<label for="uname">Enter Speaker ID</label>
						<input type="text" class="uname" id="uname" name="uname" required>
						<label for="eleCount">Enter Session </label>
						<input type="number" class="eleCount" id="eleCount" min="1" max="7" name="eleCount" required>
						<label for="audioCount">No of Recordings </label>
						<input type="number" class="audioCount" id="audioCount" min="1" max="100" name="audioCount" required>
						<input type="submit" value="submit" class="submit" id="submit" name="submit">
					</form>
				</div>

				<!--This division is for Main Recording Window (Manual)-->
				<div class="inputCountM" id="inputCountM" name="inputCountM" hidden>
					<form name="setCountM" method="post" action="testing">
						<label for="unameM">Enter Speaker ID</label>
						<input type="text" class="unameM" id="unameM" name="unameM" required>
						<label for="eleCountM">Enter Session </label>
						<input type="number" class="eleCountM" id="eleCountM" min="1" max="7" name="eleCountM" required>
						<label for="audioCountM">No of Recordings </label>
						<input type="number" class="audioCountM" id="audioCountM" name="audioCountM" required value=1 disabled>
						<input type="submit" value="Next" class="submitM" id="submitM" name="submitM">
					</form>
				</div>


				<!--This division is for Continuous Recording Window-->
				<div class="conDiv" id="conDiv" name="conDiv" hidden>
					<form name="setConUser" method="post">
						<label for="cUser">Enter Speaker ID</label>
						<input type="text" class="cUser" id="cUser" name="cUser" required>
						<input type="submit" value="submit" class="conSubmit" id="conSubmit" name="conSubmit">
					</form>
				</div>

				<!--This division is for Re-Recording Window-->				
				<div class="libAudio" id="libAudio" name="libAudio" hidden>
					<form name="reRecord" method="post" action="getSentence">
						<div class="prevText1" id="prevText1">
							<label for="getUser">Enter Speaker ID</label>
							<input type="text" name="getUser" id="getUser" class='getUser' value="">
							<label for="sesNo">Enter Session No</label>
							<input type="number" name="sesNo" id="sesNo" class='sesNo' value="">
							<label for="stNumber" id="stLabel" class="stLabel">Enter the Sentence Number:</label>
							<input type="number" name='stNumber' id="stNumber" class="stNumber" min="1" max="9999" required>
							<input type="submit" class="getSentenceBtn" id="getSentenceBtn" name="getSentenceBtn" value="submit">
						</div>
					</form>
				</div>

				<hr>
				<div class="readText">
					<nav class="fontNav">
						<a onclick='largerFont()' class="fontLink" id="larger">Larger</a>
						<a onclick="largeFont()" class="fontLink" id="large">Large</a>
						<a onclick="normalFont()" class="fontLink" id="normal">Normal</a>
					</nav>
					
					<article class="sentence" id="sentence" name="sentence">
						<p class="stn" id="stn" name="stn">#</p>
						<p class="sentence1" id="sentence1" name="sentence1">
						ಇಲ್ಲಿ ಕನ್ನಡ ವಾಕ್ಯಗಳು ಕಾಣಿಸುತ್ತವೆ. </p>
					</article>

					<audio src="" class="preAudio" id="preAudio">
						Audio is not supported in this browser.
					</audio>
				</div>
				<div class="recIcon">
					<!-- <img src="./icons/recording.png" name="recordingImg" id="recordingImg" class="recordingImg" alt="Recording Audio" hidden>

					<img name="stoppedRec" id="stoppedRec" class="stoppedRec" src="./icons/stoppedRec.png" alt="Not Recording" hidden> -->
					<p name="recordingImg" class="recordingImg" id="recordingImg" hidden>ರೆಕಾರ್ಡಿಂಗ್ ಆಗುತ್ತಿದೆ.</p>
					<p name="stoppedRec" class="stoppedRec" id="stoppedRec" hidden>ರೆಕಾರ್ಡಿಂಗ್ ಆಗುತ್ತಿಲ್ಲ.</p>
				</div>
				<p id="waveform-text" class="waveform-text">Live Waveform</p>
				<div id="audio-controls" style="margin-top: 10px; display: flex; justify-content: space-evenly;" >
					<button id="test-audio">Test Audio</button>
					<button id="retry-waveform">Retry Waveform</button>
					<button id="start-audio-record">Start Recording</button>
					<button id="stop-audio-record" disabled>Stop Recording</button>
					<button id="submit-audio-record" disabled>Submit Recording</button>
				</div>
				<div class="liveWaveform" id="liveWaveform" name="liveWaveform"></div>
				<div class="waveform" id="waveform" name="waveform">
				</div>
				<div class="showTimeline" id="showTimeline" name="showTimeline">
					<showTimeline style="display: block; position: relative; user-select: none; height: 20px; width: 100%; overflow: hidden;"><canvas width="1158" height="26" style="position: absolute; z-index: 4; width: 927px; height: 20px; left: 0px;"></canvas></showTimeline>
					<canvas width="1158" height="26" style="position: absolute; z-index: 4; width: 927px; height: 20px; left: 0px;"></canvas>
				</div>

				<!--Element to show the camera stream-->
				<div class="accessCamera">
					<!--Demo Audio Recording Window-->
					<div class="demoCamera" id="demoCamera" hidden>
						<h4 class="head4">Demo Recording Window</h4>
						<audio class="demoStream" id="demoStream" name="demoStream" autoplay="true" muted controls>
						</audio>
						<br>
						<button class="dstartVid" id="dstartVid" hidden>
							<i id = 'start' class="fas fa-microphone">
							</i>
						</button>
						<button class="dstopVid" id="dstopVid" hidden>
							<i id = 'stop' class="fas fa-stop">
							</i>
						</button>
					</div>

					<!--Main Audio Recording Window - Automatic Mode-->
					<div class="accessCamera1" id="accessCamera1" hidden>
						<form class="videoStreamF" name="videoStreamF" type='multipart/form-data'>
							<h4 class="head4">Audio Recording Window - Automatic</h4>
						<audio class="videoStream" autoplay="true" id="videoStream" muted controls>
						<!--Here camera video stream will be shown on the webpage-->
						</audio><br>
						<input type="number" name="un" class="un" id="un" hidden>
						<input type="number" name="sec" class="sec" id="sec" hidden>
						<button class="startVid" id="startVid" hidden>
							<i id = 'start' class="fas fa-microphone">
							</i>
						</button>
						<button class="stopVid" id="stopVid" hidden>
							<i id = 'stop' class="fas fa-stop">
							</i>
						</button>
						</form>
					</div>

					<!--Main Audio Recording Window - Manual Mode-->
					<div class="accessCamera2" id="accessCamera2" hidden>
						<form class="videoStreamFM" name="videoStreamFM" type='multipart/form-data'>
							<h4 class="head4">Audio Recording Window - Manual Mode</h4>
						<audio class="videoStreamM" autoplay="true" id="videoStreamM" muted controls>
						<!--Here camera video stream will be shown on the webpage-->
						</audio><br>
						<input type="number" name="unM" class="unM" id="unM" hidden>
						<input type="number" name="secM" class="secM" id="secM" hidden>
						<button class="startVidM" id="startVidM" hidden>
							<i id = 'start' class="fas fa-microphone">
							</i>
						</button>
						<button class="stopVidM" id="stopVidM" hidden>
							<i id = 'stop' class="fas fa-stop">
							</i>
						</button>
						</form>
					</div>

					<!--Continous Audio Recording Window-->
					<div class="conCamera" id="conCamera" hidden>
						<h4 class="head4">Continuous Recording Window</h4>
						<audio class="conStream" autoplay="true" id="conStream" muted controls></audio>
						<br>
						<button class="cstartVid" id="cstartVid" hidden>
							<i id = 'start' class="fas fa-microphone">
							</i>
						</button>
						<button class="cstopVid" id="cstopVid" hidden>
							<i id = 'stop' class="fas fa-stop">
							</i>
						</button>
					</div>

					<!--Re-recording Window-->
					<div class="re-record" id="re-record" hidden>
						<h4 class="head4">Re-Recording Window</h4>
						<audio class="reRecStream" id="reRecStream" name="reRecStream" autoplay="true" muted controls>
						</audio>
						<br>
						<button class="restartVid" id="restartVid" hidden>
							<i id = 'restart' class="fas fa-microphone">
							</i>
						</button>
						<button class="restopVid" id="restopVid" hidden>
							<i id = 'restop' class="fas fa-stop">
							</i>
						</button>
					</div>

				</div>
				<div class="displayVideo" id="displayVideo">
					<!--<video id="vidSave" class="vidSave" controls>	
					</video>-->
					<hr class="end" id="end">
				</div>
			</section>
		</main>

		<!--Page Right Column: To keep the left side blank-->
		<aside class="rightcol">
			<h3></h3>
		</aside>
		<!--Page Footer-->
		<footer class="footer">
			<aside class="footcol">
				<h3>About Us</h3>
				<p>IIIT, Dharwad</p>
			</aside>
			<aside class="footcol">
				<h4>Related Links</h4>
				<a href="https://iiitdwd.ac.in/" target="_blank">IIIT Dharwad</a> <br>
				<a href="https://www.aicte-india.org/" target="_blank">AICTE</a> <br>
				<a href="https://www.ugc.ac.in/" target="_blank">UGC</a> 
			</aside>
			<aside class="footcol">
				<h4>Follow IIIT Dharwad</h4>
				<a href="https://www.facebook.com/" target="_blank">Facebook</a> <br>
				<a href="https://twitter.com/" target="_blank">Twitter</a>
				<br>
				<a href="https://www.instagram.com/" target="_blank">Instagram</a> 
			</aside>
		</footer>
	</section>

	<section class="copyright" align="Center">
		<i><b>All rights are reserved to IIIT Dharwad</b></i>
	</section>

	<script type="text/javascript">
		'use strict'	
		const recordCount = document.getElementById('eleCount').value;
		var inc = 0;
		let video = document.querySelector("#demoStream");
		var aName;
		let mediaRecorder = null;
		let options;
        let recordedChunks = [];
		let wavBlob = null;
        var request;
        let videoURL;
        var serverData;
        var dateTime;
        var stNo = document.getElementById("stn");
        var sn = document.getElementById('sentence1');
		
		// var wavesurfer = WaveSurfer.create({
		// 	container: '#waveform',
		// 	waveColor: 'violet',
		// 	progressColor: 'purple',
		// 	backgroundColor: '#606060',
		// 	scrollParent: true,
		// 	interact: false,
		// 	cursorWidth: 0,
		// 	responsive: true,
		// 	plugins: [
        //     WaveSurfer.timeline.create({
        //         container: document.querySelector('#showTimeline'),
        //         formatTimeCallback: formatTimeCallback,
	    //         timeInterval: timeInterval,
	    //         primaryLabelInterval: primaryLabelInterval,
	    //         secondaryLabelInterval: secondaryLabelInterval,
	    //         primaryColor: 'blue',
	    //         secondaryColor: 'red',
	    //         primaryFontColor: 'blue',
	    //         secondaryFontColor: 'red'
	    //         }),
        // 	]
		// });

		// var livewavesurfer = WaveSurfer.create({
		//   container     : '#liveWaveform',
		//   waveColor     : 'blue',
		//   interact      : false,
		//   cursorWidth   : 1,
		//   normalize		: true,
		//   backgroundColor: '#C0C0C0',
		//   bufferSize	: 256,
		//   responsive: true,
		//   plugins: [
		//     WaveSurfer.microphone.create({
		//     })
		//   ]
		// });
		// Initialize audio context first (important for consistent behavior)
		async function initAudioContext() {
			if (!audioContext) {
				audioContext = new (window.AudioContext || window.webkitAudioContext)();
				if (audioContext.state === 'suspended') {
					await audioContext.resume();
				}
			}
			return audioContext;
		}

		// Create a simpler, more reliable live waveform visualization
		let audioContext = null;
		let analyser = null;
		let microphone = null;
		let dataArray = null;
		let canvas = null;
		let canvasCtx = null;
		let animationId = null;

		// Initialize the live waveform visualization
		async function initLiveWaveform() {
			try {
				// Get the container div
				const container = document.getElementById('liveWaveform');
				if (!container) {
					throw new Error('Live waveform container not found');
				}
				
				// Clear the container and create canvas
				container.innerHTML = '';
				canvas = document.createElement('canvas');
				canvas.id = 'liveWaveformCanvas';
				canvas.width = 800;
				canvas.height = 60;
				canvas.style.border = '2px solid #ccc';
				canvas.style.borderRadius = '5px';
				canvas.style.backgroundColor = '#f9f9f9';
				canvas.style.display = 'block';
				canvas.style.margin = '10px auto';
				canvas.style.width = '100%';
				canvas.style.height = '60px';
				
				// Add canvas to container
				container.appendChild(canvas);
				
				canvasCtx = canvas.getContext('2d');
				
				// Initialize audio context
				console.log('Creating audio context...');
				audioContext = new (window.AudioContext || window.webkitAudioContext)();
				console.log('Audio context state:', audioContext.state);
				
				if (audioContext.state === 'suspended') {
					console.log('Resuming suspended audio context...');
					await audioContext.resume();
					console.log('Audio context resumed, new state:', audioContext.state);
				}
				
				// Get microphone stream
				console.log('Requesting microphone access...');
				let stream;
				try {
					stream = await navigator.mediaDevices.getUserMedia({
						audio: {
							echoCancellation: false,
							noiseSuppression: false,
							autoGainControl: false,
							sampleRate: 44100
						}
					});
				} catch (error) {
					console.log('Failed with specific constraints, trying basic audio...');
					stream = await navigator.mediaDevices.getUserMedia({ audio: true });
				}
				console.log('Microphone stream obtained:', stream);
				
				// Create analyser node
				console.log('Creating analyser node...');
				analyser = audioContext.createAnalyser();
				analyser.fftSize = 256;
				analyser.smoothingTimeConstant = 0.8;
				console.log('Analyser created, FFT size:', analyser.fftSize);
				
				// Create microphone source
				console.log('Creating microphone source...');
				microphone = audioContext.createMediaStreamSource(stream);
				microphone.connect(analyser);
				console.log('Microphone connected to analyser');
				
				// Create data array for frequency data
				const bufferLength = analyser.frequencyBinCount;
				dataArray = new Uint8Array(bufferLength);
				
				// Store stream globally for MediaRecorder
				microphoneStream = stream;
				waveformInitialized = true;
				
				console.log('Live waveform initialized successfully');
				document.getElementById('waveform-text').textContent = 'Live Waveform - Ready';
				document.getElementById('waveform-text').style.color = 'green';
				
				return true;
			} catch (error) {
				console.error('Failed to initialize live waveform:', error);
				waveformInitialized = false;
				document.getElementById('waveform-text').textContent = 'Waveform Error: ' + error.message;
				document.getElementById('waveform-text').style.color = 'red';
				return false;
			}
		}

		// Draw the live waveform
		function drawWaveform() {
			if (!analyser || !canvasCtx) return;
			
			animationId = requestAnimationFrame(drawWaveform);
			
			analyser.getByteFrequencyData(dataArray);
			
			canvasCtx.fillStyle = '#f9f9f9';
			canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
			
			const barWidth = (canvas.width / dataArray.length) * 2.5;
			let barHeight;
			let x = 0;
			
			for (let i = 0; i < dataArray.length; i++) {
				barHeight = dataArray[i] / 2;
				
				canvasCtx.fillStyle = `rgb(${barHeight + 100}, 50, 50)`;
				canvasCtx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
				
				x += barWidth + 1;
			}
		}

		// Start the live waveform
		async function startLiveWaveform() {
			if (!waveformInitialized) {
				const success = await initLiveWaveform();
				if (!success) return false;
			}
			
			drawWaveform();
			console.log('Live waveform started');
			document.getElementById('waveform-text').textContent = 'Live Waveform - Recording...';
			document.getElementById('waveform-text').style.color = 'red';
			return true;
		}

		// Stop the live waveform
		function stopLiveWaveform() {
			if (animationId) {
				cancelAnimationFrame(animationId);
				animationId = null;
			}
			
			if (microphone) {
				microphone.disconnect();
				microphone = null;
			}
			
			if (analyser) {
				analyser = null;
			}
			
			// Clear canvas
			if (canvasCtx) {
				canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
			}
			
			console.log('Live waveform stopped');
			document.getElementById('waveform-text').textContent = 'Live Waveform - Stopped';
			document.getElementById('waveform-text').style.color = 'orange';
		}

		// Legacy WaveSurfer code (keeping for compatibility)
		var livewavesurfer = null;

		// Store the stream globally
		let microphoneStream = null;
		let waveformInitialized = false;

		// Function to reinitialize waveform if needed
		async function reinitializeWaveform() {
			try {
				console.log('Reinitializing waveform...');
				stopLiveWaveform();
				await new Promise(resolve => setTimeout(resolve, 500)); // Wait a bit
				const success = await initLiveWaveform();
				if (success) {
					console.log('Waveform reinitialized successfully');
				}
				return success;
			} catch (error) {
				console.error('Failed to reinitialize waveform:', error);
				waveformInitialized = false;
				return false;
			}
		}

		// Minimal working live waveform + recording logic

	const testBtn = document.getElementById('test-audio');
	const retryBtn = document.getElementById('retry-waveform');
	const startBtn = document.getElementById('start-audio-record');
	const stopBtn = document.getElementById('stop-audio-record');
	const submitBtn = document.getElementById('submit-audio-record');

	// Test audio button
	testBtn.addEventListener('click', async () => {
		try {
			testBtn.disabled = true;
			testBtn.textContent = 'Testing...';
			document.getElementById('waveform-text').textContent = 'Testing Audio System...';
			document.getElementById('waveform-text').style.color = 'blue';
			
			// Test basic audio functionality
			const success = await initLiveWaveform();
			
			if (success) {
				document.getElementById('waveform-text').textContent = 'Audio Test - Success!';
				document.getElementById('waveform-text').style.color = 'green';
				// Start visualization for a few seconds
				drawWaveform();
				setTimeout(() => {
					stopLiveWaveform();
					document.getElementById('waveform-text').textContent = 'Audio Test Complete';
				}, 3000);
			} else {
				document.getElementById('waveform-text').textContent = 'Audio Test - Failed';
				document.getElementById('waveform-text').style.color = 'red';
			}
		} catch (error) {
			console.error('Audio test failed:', error);
			document.getElementById('waveform-text').textContent = 'Audio Test Error: ' + error.message;
			document.getElementById('waveform-text').style.color = 'red';
		} finally {
			testBtn.disabled = false;
			testBtn.textContent = 'Test Audio';
		}
	});

	// Retry waveform button
	retryBtn.addEventListener('click', async () => {
		try {
			retryBtn.disabled = true;
			retryBtn.textContent = 'Retrying...';
			document.getElementById('waveform-text').textContent = 'Reinitializing Waveform...';
			document.getElementById('waveform-text').style.color = 'blue';
			
			const success = await reinitializeWaveform();
			
			if (success) {
				document.getElementById('waveform-text').textContent = 'Waveform Ready';
				document.getElementById('waveform-text').style.color = 'green';
			} else {
				document.getElementById('waveform-text').textContent = 'Retry Failed';
				document.getElementById('waveform-text').style.color = 'red';
			}
		} catch (error) {
			console.error('Retry failed:', error);
			document.getElementById('waveform-text').textContent = 'Retry Error: ' + error.message;
			document.getElementById('waveform-text').style.color = 'red';
		} finally {
			retryBtn.disabled = false;
			retryBtn.textContent = 'Retry Waveform';
		}
	});

	// Test microphone access on page load
	window.addEventListener('load', async () => {
		try {
			console.log('=== Browser Compatibility Check ===');
			console.log('Web Audio API supported:', !!(window.AudioContext || window.webkitAudioContext));
			console.log('MediaDevices API supported:', !!navigator.mediaDevices);
			console.log('getUserMedia supported:', !!navigator.mediaDevices.getUserMedia);
			console.log('Canvas API supported:', !!document.createElement('canvas').getContext);
			
			console.log('Testing microphone access...');
			const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
			console.log('Microphone access successful');
			stream.getTracks().forEach(track => track.stop()); // Stop the test stream
		} catch (error) {
			console.error('Microphone access failed:', error);
		}
	});

	// Periodic health check for waveform
	setInterval(() => {
		if (waveformInitialized && !analyser) {
			console.log('Waveform became inactive, attempting to restart...');
			reinitializeWaveform();
		}
	}, 5000); // Check every 5 seconds

startBtn.addEventListener('click', async () => {
    recordedChunks = [];
    wavBlob = null;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    submitBtn.disabled = true;

    try {
        // Start the live waveform
        const waveformStarted = await startLiveWaveform();
        if (!waveformStarted) {
            throw new Error('Failed to start live waveform');
        }
        
        // Wait a bit for the stream to be ready
        await new Promise(resolve => setTimeout(resolve, 500));
        
        if (microphoneStream && waveformInitialized) {
            // Create MediaRecorder with the stream
            mediaRecorder = new MediaRecorder(microphoneStream);
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) recordedChunks.push(e.data);
            };
            mediaRecorder.onstop = async () => {
                const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                wavBlob = await convertToWav(blob);
                submitBtn.disabled = false;
            };
            mediaRecorder.start();
            console.log('MediaRecorder started');
        } else {
            throw new Error('No microphone stream available');
        }
        
    } catch (error) {
        console.error('Error starting recording:', error);
        document.getElementById('waveform-text').textContent = 'Error: ' + error.message;
        document.getElementById('waveform-text').style.color = 'red';
        startBtn.disabled = false;
        stopBtn.disabled = true;
    }
});
	stopBtn.addEventListener('click', async () => {
		try {
			if (mediaRecorder && mediaRecorder.state !== 'inactive') {
				mediaRecorder.stop();
				console.log('MediaRecorder stopped');
			}
			
			// Stop the live waveform
			stopLiveWaveform();
			
			startBtn.disabled = false;
			stopBtn.disabled = true;
		} catch (error) {
			console.error('Error stopping recording:', error);
			startBtn.disabled = false;
			stopBtn.disabled = true;
		}
	});

		//Following code will autostart the webcam when webpage loads
// 		navigator.mediaDevices.getUserMedia({
// 	    	audio: true,
// 	    	// sampleRate: '16000',
// 		}).then (function(mediaStreamObj)
// 		{
// 			// options = {
//    //   			audioBitsPerSecond: 128,
// 			// }
//         	//video.srcObject = mediaStreamObj;
//             mediaRecorder = new MediaRecorder(mediaStreamObj);
//         });
        
        /*---------- START OF DEMO AUDIO RECORDING ----------*/
        //Demo Audio Recording
        dstartVid.addEventListener('click', (ev)=>
        {
        	// livewavesurfer.microphone.start();

    		if (mediaRecorder.state == 'inactive')
    		{
        		mediaRecorder.start();		
        		dstartVid.disabled = true;	//off
        		dstopVid.disabled = false;
        		startVid.disabled = true;	//off
        		stopVid.disabled = true;	//off
        		cstartVid.disabled = true;	//off
        		cstopVid.disabled = true;	//off
        		
	        	mediaRecorder.onstop = (ev)=>
	        	{
		            let blob = new Blob(chunks,
		            	{
		            		'type':'audio/mp3'
		            		//'codecs':'h.264'
		            	});

					videoURL = window.URL.createObjectURL(blob);
		            demoStream.src = videoURL;
		            
					wavesurfer.load(videoURL);
					dateTime = getDateTime();
					var u = dUser.value;
		            console.log(dateTime);
		            //send data to the node.js
		            var audio = new FormData();
		            aName = dateTime + '_' + dUser.value + '_demo.mp3';
		            request = new XMLHttpRequest();
		            //audio.append('file', videoURL);
		            audio.append('content-type', 'multipart/form-data');
		            audio.append('demoStream', blob, aName);
		            audio.append('userName', u);		   
		            request.open('post', '/uploadDemo');
		            request.send(audio);
		            chunks = [];
		            console.log(videoURL);
		            console.log('Demo audio file sent to the server for processing.');
		            aName = uname.value;
        		}

				// setInterval(event => {
				// 	mediaRecorder.requestData = function (ev) {
				// 		mediaRecorder.ondataavailable = function(ev){
		  //       			console.log("data 1");
				//             chunks.push(ev.data);
				//             let b = new Blob(chunks,
			 //            	{
			 //            		'type':'audio/mp3'
			 //            	});

				// 			videoURL = window.URL.createObjectURL(b);
				//             demoStream.src = videoURL;
				// 			wavesurfer.load(videoURL);
				// 			wavesurfer.play();
				//             wavesurfer.on('ready', function () {
	   //      					wavesurfer.setMute();
				// 				wavesurfer.play();
				// 			});
			 //        	}
				// 	}
				// }, 500);

		        mediaRecorder.ondataavailable = function(ev)
		        {
		            chunks.push(ev.data);
		            console.log(chunks);
		        }
    		}
    		else
        	{
        		dstartVid.disabled = false;
        		dstopVid.disabled = true;
        		startVid.disabled = true;
        		stopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
    	});
        /*This is a click event listener for the button with id stopVid
		  Here media recorder will stop recording the stream coming from
		  the webcam. Buttons will be enabled and disabled accordingly.
		 */
        dstopVid.addEventListener('click', (ev)=>
        {
        	wavesurfer.on('ready', function () {
        		wavesurfer.setMute();
				wavesurfer.play();
			});
			//livewavesurfer.microphone.stop();
           if (mediaRecorder.state != 'inactive') {
        		mediaRecorder.stop();
        		dstopVid.disabled = true;
        		dstartVid.disabled = false;
        		startVid.disabled = false;
        		stopVid.disabled = false;
        		cstartVid.disabled = false;
        		cstopVid.disabled = false;
        	}
        	else{
        		dstopVid.disabled = false;
        		dstartVid.disabled = true;
        		startVid.disabled = true;
        		stopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
        });
        /*---------- END OF DEMO AUDIO RECORDING ----------*/

        /*---------- START OF MAIN RECORDING WINDOW ----------*/
        startVid.addEventListener('click', (ev)=>
        {
        	//livewavesurfer.microphone.start();
    		if (mediaRecorder.state == 'inactive')
    		{
        		mediaRecorder.start();
        		startVid.disabled = true;
        		stopVid.disabled = false;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;

	        	mediaRecorder.onstop = (ev)=>
	        	{
		            let blob = new Blob(chunks,
		            	{
		            		'type':'audio/mp3'
		            		//'codecs':'h.264'
		            	});
		            chunks = [];
		            var temp = inc;
		            dateTime = getDateTime();
		            //Create a new division
		            const lName = "Audio " + (temp);

		            var newDiv = document.createElement('div');

					newDiv.setAttribute("class", lName);
					newDiv.setAttribute("id", lName);
					newDiv.style.width = '100%';
					newDiv.style.height = 'auto';
					newDiv.style.textAlign = 'center';
					//newDiv.setAttribute("width", "100%");
					//newDiv.setAttribute("height", "auto");
					//newDiv.setAttribute("style", "text-align: center; margin:auto;");
					var parent = document.getElementById('displayVideo');
					var child = document.getElementById('end');
					parent.insertBefore(newDiv, child);

		            //Create New Video Element
		            var newLabel = document.createElement('label');
					newLabel.setAttribute("class", lName);
					newLabel.setAttribute("id", lName);
					newLabel.style.marginLeft = "45%";
					newLabel.style.marginRight = "45%";
					newLabel.style.width = "10%";
					newLabel.style.textAlign = "center";
					// newLabel.setAttribute("style", "display: table-row;");
					//newLabel.setAttribute("style", "margin-left: 40%;");
					//newLabel.setAttribute("style", "margin-right: 40%;");
					//newLabel.setAttribute("style", "width: 10%;");
					const labelName = document.createTextNode(lName);
					newLabel.appendChild(labelName);
					parent = document.getElementById('displayVideo');
					child = document.getElementById('end');
					parent.insertBefore(newLabel, child);

					//Create an video element
					const vName = "audio" + (temp);
					var newVideo = document.createElement('audio');
					newVideo.setAttribute("class", vName);
					newVideo.setAttribute("id", vName);
					newVideo.setAttribute("width", "50%");
					newVideo.setAttribute("background-color","#666");
					newVideo.setAttribute("autoplay","false");
					newVideo.setAttribute("controls", "controls");
					newVideo.muted = true;
					//newVideo.setAttribute("style", "display: table-row;");
					newVideo.style.marginLeft = "35%";
					newVideo.style.marginRight = "35%";
					newVideo.style.width = "30%";
					document.body.appendChild(newVideo);
					parent.insertBefore(newVideo, end);
			        //Closed
		            videoURL = window.URL.createObjectURL(blob);
		            wavesurfer.load(videoURL);
		            
		            // console.log(videoURL);
		             newVideo.src = videoURL;
		             newVideo.preload = 'none';

		            //Upload to the directory
		            var audio = new FormData();
		            var userName = un.value;
		            var secNo = sec.value;
		            // console.log('Sending userName'+userName);
		            // aName = dateTime + '_' + uname.value + '_Main.mp3';
		            aName = dateTime + '_'+ userName + '_' + secNo +'_KA.';
		            request = new XMLHttpRequest();
		            //audio.append('file', videoURL);
		            audio.append('content-type', 'multipart/form-data');
		            audio.append('newVideo', blob, aName);
		            audio.append('userName', userName);
		            audio.append('section', secNo);
		            request.open('post', '/uploadMain');
		            request.send(audio);
		            chunks = [];
		            blob = [];
		            console.log('Main audio file sent to the server for processing.');
		            aName = '';
		            temp++;
		            // const a = document.createElement('a');
		            // a.display = "none";
		            // a.href = videoURL;
		            // a.download = vName+".mp3";
		            // a.click();
        		}
		        mediaRecorder.ondataavailable = function(ev)
		        {
		            chunks.push(ev.data);
		            console.log(chunks);
		        }
    		}
    		else
        	{
        		startVid.disabled = false;
        		stopVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;

        	}
            console.log(mediaRecorder.state);
            inc++;
    	});

        /*This is a click event listener for the button with id stopVid
		  Here media recorder will stop recording the stream coming from
		  the webcam. Buttons will be enabled and disabled accordingly.
		 */
        stopVid.addEventListener('click', (ev)=>
        {
   //      	wavesurfer.on('ready', function () {
   //      		wavesurfer.setMute();
   //  			wavesurfer.play();
			// });
			//livewavesurfer.microphone.stop();
           if (mediaRecorder.state != 'inactive') {
        		mediaRecorder.stop();
        		stopVid.disabled = true;
        		startVid.disabled = false;
        		dstartVid.disabled = false;
        		dstopVid.disabled = false;
        		cstartVid.disabled = false;
        		cstopVid.disabled = false;
        	}
        	else{
        		stopVid.disabled = false;
        		startVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
        });
        /*---------- END OF MAIN RECORDING WINDOW (AUTOMATIC MODE) ----------*/

        /*---------- START OF MAIN RECORDING WINDOW (MANUAL MODE)----------*/
        startVidM.addEventListener('click', (ev)=>
        {
        	//livewavesurfer.microphone.start();
    		if (mediaRecorder.state == 'inactive')
    		{
        		mediaRecorder.start();
        		startVidM.disabled = true;
        		stopVidM.disabled = false;
        		startVid.disabled = true;
        		stopVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;

	        	mediaRecorder.onstop = (ev)=>
	        	{
		            let blob = new Blob(chunks,
		            	{
		            		'type':'audio/mp3'
		            		//'codecs':'h.264'
		            	});
		            chunks = [];
		            var temp = inc;
		            dateTime = getDateTime();
		            //Create a new division
		            const lName = "Audio " + (temp);

		            var newDiv = document.createElement('div');

					newDiv.setAttribute("class", lName);
					newDiv.setAttribute("id", lName);
					newDiv.style.width = '100%';
					newDiv.style.height = 'auto';
					newDiv.style.textAlign = 'center';
					//newDiv.setAttribute("width", "100%");
					//newDiv.setAttribute("height", "auto");
					//newDiv.setAttribute("style", "text-align: center; margin:auto;");
					var parent = document.getElementById('displayVideo');
					var child = document.getElementById('end');
					parent.insertBefore(newDiv, child);

		            //Create New Video Element
		            var newLabel = document.createElement('label');
					newLabel.setAttribute("class", lName);
					newLabel.setAttribute("id", lName);
					newLabel.style.marginLeft = "45%";
					newLabel.style.marginRight = "45%";
					newLabel.style.width = "10%";
					newLabel.style.textAlign = "center";
					// newLabel.setAttribute("style", "display: table-row;");
					//newLabel.setAttribute("style", "margin-left: 40%;");
					//newLabel.setAttribute("style", "margin-right: 40%;");
					//newLabel.setAttribute("style", "width: 10%;");
					const labelName = document.createTextNode(lName);
					newLabel.appendChild(labelName);
					parent = document.getElementById('displayVideo');
					child = document.getElementById('end');
					parent.insertBefore(newLabel, child);

					//Create an video element
					const vName = "audio" + (temp);
					var newVideo = document.createElement('audio');
					newVideo.setAttribute("class", vName);
					newVideo.setAttribute("id", vName);
					newVideo.setAttribute("width", "50%");
					newVideo.setAttribute("background-color","#666");
					newVideo.setAttribute("autoplay","false");
					newVideo.setAttribute("controls", "controls");
					newVideo.muted = true;
					//newVideo.setAttribute("style", "display: table-row;");
					newVideo.style.marginLeft = "35%";
					newVideo.style.marginRight = "35%";
					newVideo.style.width = "30%";
					document.body.appendChild(newVideo);
					parent.insertBefore(newVideo, end);
			        //Closed
		            videoURL = window.URL.createObjectURL(blob);
		            wavesurfer.load(videoURL);
		            
		            // console.log(videoURL);
		             newVideo.src = videoURL;
		             newVideo.preload = 'none';

		            //Upload to the directory
		            var audio = new FormData();
		            var userName = unM.value;
		            var secNo = secM.value;
		            console.log('Sending userName'+userName+' secNo: '+secNo);
		            // aName = dateTime + '_' + uname.value + '_Main.mp3';
		            aName = dateTime + '_'+ userName + '_' + secNo +'_KA.';
		            request = new XMLHttpRequest();
		            //audio.append('file', videoURL);
		            audio.append('content-type', 'multipart/form-data');
		            audio.append('newVideo', blob, aName);
		            audio.append('userName', userName);
		            audio.append('section', secNo);
		            request.open('post', '/uploadMain');
		            request.send(audio);
		            chunks = [];
		            blob = [];
		            console.log('Main audio file sent to the server for processing.');
		            aName = '';
		            temp++;
		            // const a = document.createElement('a');
		            // a.display = "none";
		            // a.href = videoURL;
		            // a.download = vName+".mp3";
		            // a.click();
        		}
		        mediaRecorder.ondataavailable = function(ev)
		        {
		            chunks.push(ev.data);
		            console.log(chunks);
		        }
    		}
    		else
        	{
        		startVidM.disabled = false;
        		stopVidM.disabled = true;
        		startVid.disabled = true;
        		stopVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;

        	}
            console.log(mediaRecorder.state);
            inc++;
    	});

        /*This is a click event listener for the button with id stopVid
		  Here media recorder will stop recording the stream coming from
		  the webcam. Buttons will be enabled and disabled accordingly.
		 */
        stopVidM.addEventListener('click', (ev)=>
        {
   //      	wavesurfer.on('ready', function () {
   //      		wavesurfer.setMute();
   //  			wavesurfer.play();
			// });
			//livewavesurfer.microphone.stop();
           if (mediaRecorder.state != 'inactive') {
        		mediaRecorder.stop();
        		stopVidM.disabled = true;
        		startVidM.disabled = false;
        		stopVid.disabled = false;
        		startVid.disabled = false;
        		dstartVid.disabled = false;
        		dstopVid.disabled = false;
        		cstartVid.disabled = false;
        		cstopVid.disabled = false;
        	}
        	else{
        		stopVidM.disabled = false;
        		startVidM.disabled = true;
        		stopVid.disabled = true;
        		startVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        		cstartVid.disabled = true;
        		cstopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
        });
        /*---------- END OF MAIN RECORDING WINDOW (MANUAL MODE)----------*/



        /*---------- START OF CONTINUOUS RECORDING WINDOW ----------*/
        //Continous Audio Recording
        cstartVid.addEventListener('click', (ev)=>
        {
        	// livewavesurfer.microphone.start();
        	aName = document.getElementById('cUser').value;
    		if (mediaRecorder.state == 'inactive')
    		{
        		mediaRecorder.start();
        		cstartVid.disabled = true;
        		cstopVid.disabled = false;
        		startVid.disabled = true;
        		stopVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;

	        	mediaRecorder.onstop = (ev)=>
	        	{
		            let blob = new Blob(chunks,
		            	{
		            		'type':'audio/mp3'
		            		//'codecs':'h.264'
		            	});
		            videoURL = window.URL.createObjectURL(blob);
		            wavesurfer.load(videoURL);
		            conStream.src = videoURL;
		            dateTime = getDateTime();
		            var u = cUser.value;
		            //send data to the node.js
		            var audio = new FormData();
		            aName = dateTime + '_' + aName + '_continuos';
		            //aName = aName + '_continuos';
		            var passName = aName +'.mp3';
		            request = new XMLHttpRequest();
		            //audio.append('file', videoURL);
		            audio.append('content-type', 'multipart/form-data');
		            audio.append('conStream', blob, passName);
		            audio.append('userName', u);
		            request.open('post', '/uploadCon');
		            request.send(audio);
		            chunks = [];
		            console.log(videoURL);
		            console.log('Continuous audio file sent to the server for processing.');

		            const a = document.createElement('a');
		            a.display = "none";
		            a.href = videoURL;
		            console.log(aName);
		            a.download = aName+".mp3";
		            a.click();
		            aName = document.getElementById('uname').value;
        		}
		        mediaRecorder.ondataavailable = function(ev)
		        {
		            chunks.push(ev.data);
		            console.log(chunks);
		        }
    		}
    		else
        	{
        		cstartVid.disabled = false;
        		cstopVid.disabled = true;
        		startVid.disabled = true;
        		stopVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
    	});

        /*This is a click event listener for the button with id stopVid
		  Here media recorder will stop recording the stream coming from
		  the webcam. Buttons will be enabled and disabled accordingly.
		 */
        cstopVid.addEventListener('click', (ev)=>
        {
   //      	wavesurfer.on('ready', function () {
   //      		wavesurfer.setMute();
   //  			wavesurfer.play();
			// });
			// livewavesurfer.microphone.stop();
           if (mediaRecorder.state != 'inactive') {
        		mediaRecorder.stop();
        		cstopVid.disabled = true;
        		cstartVid.disabled = false;
        		startVid.disabled = false;
        		stopVid.disabled = false;
        		dstartVid.disabled = false;
        		dstopVid.disabled = false;
        	}
        	else{
        		cstopVid.disabled = false;
        		cstartVid.disabled = true;
        		startVid.disabled = true;
        		stopVid.disabled = true;
        		dstartVid.disabled = true;
        		dstopVid.disabled = true;
        	}
            console.log(mediaRecorder.state);
        });
        /*---------- END OF MAIN RECORDING WINDOW ----------*/

        /*---------- RECEIVE DATA FROM SERVER (AUTOMATIC)----------*/
		submit.addEventListener('click', async (ev) => 
    	{	
	    	ev.preventDefault();
	    	var uName = document.getElementById('uname').value;
	    	var secCount = document.getElementById('eleCount').value;
	    	var senCount = document.getElementById('audioCount').value;
	    	let canSpeak = '';
	    	let currentPtr=0;
	    	let stPointer = 0, ptr = 0, nptr = 0;
	    	
	    	if(uName == '' || secCount == '' || senCount == '')
	    	{
	    		alert('Enter all the details.');
	    	}
	    	else if(senCount < 1 || senCount > 1031 || secCount < 1 || secCount > 7)
	    	{
	        	if(senCount < 1 || senCount > 1031)
	        		alert('Invalid Sentence Number.')
	        	if (secCount < 1 || secCount > 7)
	        		alert('Invalid Session ID.')
	    	}
	    	else
	    	{
	    		$.ajax({
	            type: 'POST',
	            url: "/testing",
	            async: true,
	            data: 
	                JSON.stringify({
	                    user: uName,
	                    ele: secCount,
	                    rec: senCount
	            }),
	            dataType: 'json',
	            contentType: 'application/json; charset=utf-8',
	            success: function ()
	            {
	    			const count = parseInt(document.getElementById('audioCount').value);
	    			document.getElementById('un').value = uname.value;
	    			document.getElementById('sec').value = eleCount.value;
	    			console.log(count);
	    			var i=1, j=0, srid=0, stid=0, srdata=0, main = 0, addata=0;

	    			$.get('/langStatus', async function(data, status){
	    				canSpeak = data;
	    				console.log('Can Speaker speaks Kannada: '+canSpeak);
	    			})

	    			$.get('/getPointer', async function(data, result){
	    				console.log('Data Received from Node: '+data)
	    				currentPtr = data;
	    				currentPtr = parseInt(currentPtr);
	    				console.log('Value of pointer after conversion (currentPtr): '+currentPtr);
	    			})

	    			$.get("/testing", async function(data, status)
	    			{
				    	serverData = data;
				    	stPointer = currentPtr;
				    	//stPointer = parseInt(serverData[0]);
				    	//console.log('Current pointer: '+serverData[0])
				    	console.log('stPointer value: Current pointer: '+stPointer)
				    	
				    	if(stPointer <= 0 || stPointer >= 1032)
				    	{
				    		ptr = 1;
				    		console.log('Current pointer: '+ptr)
				    	}
				    	else
				    	{
				    		ptr = stPointer;
				    		console.log('New Current pointer: '+ptr)
				    	}
				    	
				    	if(count=='')
	    					console.log("yyy",count);
	    				else
	    				{
	    					if(Object.keys(serverData).length === 0)
	    					{
	    						alert('User Name is invalid.');
	    						uname.value = '';
	                    		eleCount.value = '';
	                    		audioCount.value = '';
	    					}
	    					else
	    					{
	    						console.log(serverData);
	    						console.log('Can Speaker speaks Kannada: '+canSpeak);
		        				let t1=1000, t2=6000, t3=7000, t4 = 12000, tn1, tn2, tn3;
		        				tn1 = tn2 = tn3 = 12000;	//11000-1000=10000
		        	// 			if(count==1)
		        	// 			{
		        	// 				console.log('Value of Count in 1: '+count);
		        	// 				setTimeout(function()
		        	// 				{
			        // 					stNo.innerHTML = ptr;
							    // 		sn.innerHTML = serverData[ptr];
							    // 		preAudio.src = './data/'+ptr+'.wav';
							    // 		if(canSpeak==='false')
							    // 			preAudio.play();
		        	// 				}, t1)

		        	// 				setTimeout(function()
		        	// 				{
						    	// 		var audio = new Audio('./sounds/beep.wav');
	        		// 					audio.play();
		        	// 				}, t2)

			        // 				setTimeout(function() {
			        // 					document.getElementById("startVid").click();
			        // 					document.getElementById('recordingImg').style.display = 'inline';
	 									// document.getElementById('stoppedRec').style.display = 'none';
			        // 					livewavesurfer.microphone.start();
			        // 				}, t3)

			        // 				setTimeout(function() {
			        // 					document.getElementById("stopVid").click();
			        // 					document.getElementById('recordingImg').style.display = 'none';
	 									// document.getElementById('stoppedRec').style.display = 'inline';
	 									// livewavesurfer.microphone.stop();
			        // 				}, t4)
			        // 				nptr = ptr;
			        // 				ptr = currentPtr = 0;
			        // 				console.log('New Counter after 1 iteration:'+nptr);
			        // 				$.ajax({
							    //         type: 'POST',
							    //         url: "/savePointer",
							    //         async: true,
							    //         data: 
							    //             JSON.stringify({
							    //                 pointer: ++nptr,
							    //         }),
							    //         dataType: 'json',
							    //         contentType: 'application/json; charset=utf-8',
							    //         success: function ()
							    //         {
							    //         	alert('Pointer Updated Successfully.')
							    //         }
		        	// 				});
		        	// 				nptr = 0;
			        // 			}
		        	// 			else
		        	// 			{
		        					function sleep(ms) {
								      return new Promise(resolve => setTimeout(resolve, ms));
								   	}
								   	let loop = 1;
								   	let counter = (count + ptr);
								   	
								   	console.log('counter value: '+counter);
								   	//console.log(typeof counter);

								   	async function displayText() {
								      	console.log('This is main recording');
								      	for (let i = ptr; i < counter; i++)
								      	{
								      		nptr = i;
								      		if(i >= 1032)
								      		{
								      			break;
								      		}
								      		console.log('NPTR: '+nptr);
								      		console.log('loop no: '+loop);      
								         	//await sleep(1000);
								         	setTimeout(function() {
					        					stNo.innerHTML = i;
									    		sn.innerHTML = serverData[i];
									    		preAudio.src = './data/lambani/'+i+'.wav';
									    		if(canSpeak==='false')
							    					preAudio.play();
				        					}, await sleep(1000)) //1 sec

				        					setTimeout(function() {
								    		var audio = new Audio(
												'./sounds/beep.wav');
			        							audio.play();
				        					}, await sleep(6000))	//5sec

					        				setTimeout(function() {
					        					document.getElementById("startVid").click();
					        					document.getElementById('recordingImg').style.display = 'inline';
	 											document.getElementById('stoppedRec').style.display = 'none';
	 											// livewavesurfer.microphone.start();
					        				}, await sleep(1000))	//6sec

					        				setTimeout(function() {
					        					document.getElementById("stopVid").click();
					        					document.getElementById('recordingImg').style.display = 'none';
	 											document.getElementById('stoppedRec').style.display = 'inline';
	 											// livewavesurfer.microphone.stop();
					        				}, await sleep(6000))
					        				loop++;	//11sec
								      	}
								      	canSpeak = '';
								      	ptr = currentPtr = 0;
								      	nptr++;
								      	if(nptr >= 1032)
								      		nptr = 0;
								      	else
								      		nptr = nptr;
								   		console.log('Final pointer: '+nptr);
								   		$.ajax({
								            type: 'POST',
								            url: "/savePointer",
								            async: true,
								            data: 
								                JSON.stringify({
								                    pointer: nptr,
								            }),
								            dataType: 'json',
								            contentType: 'application/json; charset=utf-8',
								            success: function ()
								            {
								            	alert('Pointer Updated Successfully.')
								            }
			        					});
			        					nptr = 0;
								   	}
								   	displayText()
								   	currentPtr = 0;
	        					//}
	        				}
	    				}
					});
	        	}
	    	});
    	}	
	});

/*---------- RECEIVE DATA FROM SERVER (MANUAL MODE)----------*/
	submitM.addEventListener('click', async (ev) => 
	{	
		submitM.disabled = true;
    	ev.preventDefault();
    	var uName = document.getElementById('unameM').value;
    	var secCount = document.getElementById('eleCountM').value;
    	var senCount = document.getElementById('audioCountM').value;
    	let canSpeak = '';
    	let currentPtr=0;
    	let stPointer = 0, ptr = 0, nptr = 0;
    	
    	if(uName == '' || secCount == '' || senCount == '')
    	{
    		alert('Enter all the details.');
    	}
    	else if(senCount < 1 || senCount > 1031 || secCount < 1 || secCount > 7)
    	{
        	if(senCount < 1 || senCount > 1031)
        		alert('Invalid Sentence Number.')
        	if (secCount < 1 || secCount > 7)
        		alert('Invalid Session ID.')
    	}
    	else
    	{
    		$.ajax({
            type: 'POST',
            url: "/testing",
            async: true,
            data: 
                JSON.stringify({
                    user: uName,
                    ele: secCount,
                    rec: senCount
            }),
            dataType: 'json',
            contentType: 'application/json; charset=utf-8',
            success: function ()
            {
    			const count = parseInt(document.getElementById('audioCountM').value);
    			
    			//These are hidden fields to send data to another route
    			document.getElementById('unM').value = unameM.value;
    			document.getElementById('secM').value = eleCountM.value;

    			console.log(count);
    			var i=1, j=0, srid=0, stid=0, srdata=0, main = 0, addata=0;

    			$.get('/langStatus', async function(data, status){
    				canSpeak = data;
    				console.log('Can Speaker speaks Kannada: '+canSpeak);
    			})

    			$.get('/getPointer', async function(data, result){
    				console.log('Data Received from Node: '+data)
    				currentPtr = data;
    				currentPtr = parseInt(currentPtr);
    				console.log('Value of pointer after conversion (currentPtr): '+currentPtr);
    			})

    			$.get("/testing", async function(data, status)
    			{
			    	serverData = data;
			    	stPointer = currentPtr;
			    	//stPointer = parseInt(serverData[0]);
			    	//console.log('Current pointer: '+serverData[0])
			    	console.log('stPointer value: Current pointer: '+stPointer)
			    	
			    	if(stPointer <= 0 || stPointer >= 1032)
			    	{
			    		ptr = 1;
			    		console.log('Current pointer: '+ptr)
			    	}
			    	else
			    	{
			    		ptr = stPointer;
			    		console.log('New Current pointer: '+ptr)
			    	}
			    	
			    	if(count=='')
    					console.log("yyy",count);
    				else
    				{
    					if(Object.keys(serverData).length === 0)
    					{
    						alert('User Name is invalid.');
    						uname.value = '';
                    		eleCount.value = '';
                    		audioCount.value = '';
    					}
    					else
    					{
    						console.log(serverData);
    						console.log('Can Speaker speaks Kannada: '+canSpeak);
	        				let t1=1000, t2=6000, t3=7000, t4 = 12000, tn1, tn2, tn3;
	        				tn1 = tn2 = tn3 = 12000;	//11000-1000=10000
        					console.log('Value of Count in 1: '+count);
        					
        					setTimeout(function()
        					{
        						console.log('Pointer value inside setTimeout: '+ptr)
	        					stNo.innerHTML = ptr;
					    		sn.innerHTML = serverData[ptr];
					    		preAudio.src = './data/lambani/'+ptr+'.wav';
					    		if(canSpeak==='false')
					    			preAudio.play();
        					}, t1)

        					setTimeout(function()
        					{
				    			var audio = new Audio('./sounds/beep.wav');
    							audio.play();
        					}, t2)

	        				setTimeout(function() {
	        					document.getElementById("startVidM").click();
	        					document.getElementById('recordingImg').style.display = 'inline';
								document.getElementById('stoppedRec').style.display = 'none';
	        					// livewavesurfer.microphone.start();
	        				}, t3)

	        				setTimeout(function() {
	        					document.getElementById("stopVidM").click();
	        					document.getElementById('recordingImg').style.display = 'none';
								document.getElementById('stoppedRec').style.display = 'inline';
								// livewavesurfer.microphone.stop();
	        				}, t4)
	        				nptr = ptr;
	        				// ptr = currentPtr = 0;
	        				console.log('New Counter after 1 iteration:'+nptr);
	        				$.ajax({
					            type: 'POST',
					            url: "/savePointer",
					            async: true,
					            data: 
					                JSON.stringify({
					                    pointer: ++nptr,
					            }),
					            dataType: 'json',
					            contentType: 'application/json; charset=utf-8',
					            success: function ()
					            {
					            	alert('Pointer Updated Successfully.')
					            }
        					});
        					nptr = 0;
        				}
    				}
				});
        	}
    	});
	submitM.disabled = false;
	}	
});

    getSentenceBtn.addEventListener('click', (ev) =>
	{
		ev.preventDefault();
		var getUser = document.getElementById('getUser').value;
    	var session = document.getElementById('sesNo').value;
    	var stNum = document.getElementById('stNumber').value;

    	if(getUser == '' || stNum == '' || session == '')
    	{
        		alert('Enter valid details.');
        }
        else if(stNum < 1 || stNum > 1031 || session < 1 || session > 8)
        {
        	if(stNum < 1 || stNum > 1031)
        		alert('Invalid Sentence Number.')
        	if (session < 1 || session > 7)
        	{
        		alert('Invalid Session ID.')
        	}
        }
        else
        {
        	$.ajax({
			    type: 'POST',
			    url: "/getSentence",
			    async: true,
			    data: 
			        JSON.stringify({
			            user: getUser,
			            session: sesNo,
			            sentence: stNum,
			    }),
			    dataType: 'json',
			    contentType: 'application/json; charset=utf-8',
			    success: function () {
			    	var i = stNumber;
			    	document.getElementById('un').value = getUser;
	        		document.getElementById('sec').value = session;
					$.get("/getSentence", function(data, status)
					{
				      	serverData = data;

						console.log(serverData);
			  			stNo.innerHTML = stNumber.value;
			    		sn.innerHTML = serverData[stNumber.value];
			    		preAudio.src = './data/lambani/'+stNumber.value+'.wav';

			    		setTimeout(function(){
						var audio = new Audio('./sounds/beep.wav');
		        			audio.play();
			        	}, 5000);

			    		setTimeout(function(){
			    			document.getElementById('startVid').click();
			    			document.getElementById('recordingImg').style.display = 'inline';
	 							document.getElementById('stoppedRec').style.display = 'none';
			    			// livewavesurfer.microphone.start();
			    		}, 6000);

			    		setTimeout(function() {
			    			document.getElementById('stopVid').click();
			    			document.getElementById('recordingImg').style.display = 'none';
	 							document.getElementById('stoppedRec').style.display = 'inline';
	 							// livewavesurfer.microphone.stop();
			    		}, 11000);
					});
				}
			});
    	}	
	});

    // demoSubmit.addEventListener('click', (ev) =>
	// {
	// 	ev.preventDefault();
	// 	let duname = document.getElementById('dUser').value;
    // 	if(duname == '')
    // 	{
    //     		alert('Enter valid Speaker ID');
    //     }
    //     else
    //     {
    //     	$.ajax({
	// 		    type: 'POST',
	// 		    url: "/getdemoUser",
	// 		    async: true,
	// 		    data: 
	// 		        JSON.stringify({
	// 		            user: duname
	// 		    }),
	// 		    dataType: 'json',
	// 		    contentType: 'application/json; charset=utf-8',
	// 		    success: function () {
	// 				$.get("/getdemoUser", function(data, status)
	// 				{
	// 					serverData = data;
	// 			    	console.log('Data from Server:' + serverData);
	// 					if (serverData === 1) {

	// 						setTimeout(function(){
	// 							stNo.innerHTML = '1';
	// 				    		sn.innerHTML = 'ಇದು ಮೊದಲ ಡೆಮೊ ವಾಕ್ಯ';
	// 				    		preAudio.src = './data/o1.wav';
	// 				    		preAudio.play();
	// 			        	}, 1000);

	// 			    		setTimeout(function(){
	// 						var audio = new Audio('./sounds/beep.wav');
	// 		        			audio.play();
	// 			        	}, 6000);

	// 			    		setTimeout(function(){
	// 			    			document.getElementById('dstartVid').click();
	// 			    			document.getElementById('recordingImg').style.display = 'inline';
	//  							document.getElementById('stoppedRec').style.display = 'none';
	// 			    			livewavesurfer.microphone.start();
	// 			    		}, 7000);

	// 			    		setTimeout(function() {
	// 			    			document.getElementById('dstopVid').click();
	// 			    			document.getElementById('recordingImg').style.display = 'none';
	//  							document.getElementById('stoppedRec').style.display = 'inline';
	//  							livewavesurfer.microphone.stop();
	// 			    		}, 12000);

	// 			    		setTimeout(function(){
	// 							stNo.innerHTML = 2;
	// 				    		sn.innerHTML = 'ಇದು ಎರಡನೇ ಡೆಮೊ ವಾಕ್ಯ';
	// 				    		preAudio.src = './data/o2.wav';
	// 				    		preAudio.play();
	// 			        	}, 13000);
				    		
	// 			    		setTimeout(function(){
	// 						var audio = new Audio('./sounds/beep.wav');
	// 		        			audio.play();
	// 			        	}, 18000);

	// 			    		setTimeout(function(){
	// 			    			document.getElementById('dstartVid').click();
	// 			    			document.getElementById('recordingImg').style.display = 'inline';
	//  							document.getElementById('stoppedRec').style.display = 'none';
	// 			    			livewavesurfer.microphone.start();
	// 			    		}, 19000);

	// 			    		setTimeout(function() {
	// 			    			document.getElementById('dstopVid').click();
	// 			    			document.getElementById('recordingImg').style.display = 'none';
	//  							document.getElementById('stoppedRec').style.display = 'inline';
	//  							livewavesurfer.microphone.stop();
	// 			    		}, 24000);
	// 			    	}
	// 			    	else
	// 			    	{
	// 			    		alert('User Not Found');
	// 			    		dUser.value = '';
	// 			    	}
	// 				});
	// 			}
	// 		});
    // 	}	
	// });

	demoSubmit.addEventListener('click', async function(ev) {
		ev.preventDefault();
		let duname = document.getElementById('dUser').value.trim();
		if (!duname) {
			alert('Enter valid Speaker ID');
			return;
		}
		try {
			const res = await fetch('/getdemoUser', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ user: duname })
			});
			const data = await res.json();
			if (res.ok && data.exists) {
				document.getElementById('stn').textContent = data.id;
				// Optionally, do any other UI updates here
			} else {
				alert('User Not Found');
				document.getElementById('dUser').value = '';
				document.getElementById('stn').textContent = '#';
			}
		} catch (err) {
			alert('Error checking Speaker ID');
			document.getElementById('stn').textContent = '#';
		}
	});
	conSubmit.addEventListener('click', (ev) =>
	{
		ev.preventDefault();
		let cuname = document.getElementById('cUser').value;
    	if(cuname == '')
    	{
        		alert('Enter valid Speaker ID');
        }
        else
        {
        	$.ajax({
			    type: 'POST',
			    url: "/getconUser",
			    async: true,
			    data: 
			        JSON.stringify({
			            user: cuname
			    }),
			    dataType: 'json',
			    contentType: 'application/json; charset=utf-8',
			    success: function () {
					$.get("/getconUser", function(data, status)
					{
						serverData = data;
				    	console.log('Data from Server:' + serverData);
						if (serverData === 1) {

							setTimeout(function(){
								stNo.innerHTML = '1';
					    		sn.innerHTML = 'ಇದು ಮೊದಲ ಡೆಮೊ ವಾಕ್ಯ';
					    		preAudio.src = './data/o1.wav';
				        	}, 1000);

				    		setTimeout(function(){
							var audio = new Audio('./sounds/beep.wav');
			        			audio.play();
				        	}, 6000);

				    		setTimeout(function(){
				    			document.getElementById('cstartVid').click();
				    			document.getElementById('recordingImg').style.display = 'inline';
	 							document.getElementById('stoppedRec').style.display = 'none';
				    			// livewavesurfer.microphone.start();
				    		}, 7000);

				    		setTimeout(function() {
				    			document.getElementById('cstopVid').click();
				    			document.getElementById('recordingImg').style.display = 'none';
	 							document.getElementById('stoppedRec').style.display = 'inline';
	 							// livewavesurfer.microphone.stop();
				    		}, 67000);
				    	}
				    	else
				    	{
				    		alert('User Not Found');
				    		cUser.value = '';
				    	}
					});
				}
			});
    	}	
	});
	
	</script>

<script>



// --- Stop Recording ---


// --- Submit Recording ---
// --- Submit Recording ---
submitBtn.addEventListener('click', async () => {
    if (!wavBlob) {
        alert('No audio to submit!');
        return;
    }
    submitBtn.disabled = true;

    const patientId = document.getElementById('stn').textContent;
    if (!patientId || patientId === '#') {
        alert('Enter a valid Patient ID before submitting!');
        submitBtn.disabled = false;
        return;
    }
    const formData = new FormData();
    formData.append('file', wavBlob, 'audio.wav');
    // Add patient ID from #stn
    formData.append('patientId', patientId);
    console.log(patientId);
    try {
        const response = await fetch('/uploadRecording', {
            method: 'POST',
            body: formData
        });
        if (response.ok) {
            alert('Audio uploaded!');
        } else {
            alert('Upload failed');
        }
    } catch (err) {
        alert('Error uploading: ' + err.message);
    }
    submitBtn.disabled = false;
});

// --- Convert audio/webm to WAV ---
async function convertToWav(blob) {
    const arrayBuffer = await blob.arrayBuffer();
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    const wavBuffer = encodeWAV(audioBuffer);
    return new Blob([wavBuffer], { type: 'audio/wav' });
}

function encodeWAV(audioBuffer) {
    const numChannels = audioBuffer.numberOfChannels;
    const sampleRate = audioBuffer.sampleRate;
    const format = 1;
    const bitDepth = 16;
    const samples = audioBuffer.length;
    const buffer = new ArrayBuffer(44 + samples * numChannels * 2);
    const view = new DataView(buffer);

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + samples * numChannels * 2, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, format, true);
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numChannels * 2, true);
    view.setUint16(32, numChannels * 2, true);
    view.setUint16(34, bitDepth, true);
    writeString(view, 36, 'data');
    view.setUint32(40, samples * numChannels * 2, true);

    let offset = 44;
    for (let i = 0; i < samples; i++) {
        for (let ch = 0; ch < numChannels; ch++) {
            const sample = audioBuffer.getChannelData(ch)[i];
            const s = Math.max(-1, Math.min(1, sample));
            view.setInt16(offset, s * 0x7FFF, true);
            offset += 2;
        }
    }
    return view;

}
document.addEventListener('DOMContentLoaded', function() {
    const demoSubmit = document.getElementById('demoSubmit');
    demoSubmit.addEventListener('click', async function(ev) {
        ev.preventDefault();
        let duname = document.getElementById('dUser').value.trim();
        if (!duname) {
            alert('Enter valid Speaker ID');
            return;
        }
        try {
            const res = await fetch('/getdemoUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user: duname })
            });
            const data = await res.json();
            if (res.ok && data.exists) {
                document.getElementById('stn').textContent = data.id;
            } else {
                alert('User Not Found');
                document.getElementById('dUser').value = '';
                document.getElementById('stn').textContent = '#';
            }
        } catch (err) {
            alert('Error checking Speaker ID');
            document.getElementById('stn').textContent = '#';
        }
    });
});
</script>
</body>
</html>